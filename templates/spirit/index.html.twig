{% extends 'base.html.twig' %}

{% block title %}{{ 'spirit.title'|trans }}{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    {{ encore_entry_link_tags('spirit') }}
{% endblock %}

{% block body %}
<div class="container mt-4">
    <input type="hidden" id="spirit-id" value="{{ spiritId is defined ? spiritId : '' }}">
    <div class="glass-panel pt-4">
        {# <div class="text-white p-4">
            <h2 class="mb-0">{{ 'spirit.title'|trans }}</h2>
        </div> #}
        <div class="px-4 pb-4 pt-1">
            <div id="spirit-container">
                <div class="text-center mb-4" id="spirit-loading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">{{ 'ui.loading'|trans }}</span>
                    </div>
                    <p class="mt-2">{{ 'spirit.detail.connecting'|trans }}</p>
                </div>
                
                <div id="spirit-display" class="d-none">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="w-50 float-start">
                                <div class="spirit-avatar-container big">
                                    <div id="spiritChatAvatar" class="spirit-avatar d-flex align-items-center justify-content-center text-secondary">
                                        <i class="mdi mdi-ghost spirit-detail-icon"></i>
                                    </div>
                                </div>
                            </div>
                            <div class="w-50 float-end">
                                <div class="text-start">
                                    <h3 id="spirit-name-display" class="mb-2">{{ 'spirit.name'|trans }}</h3>
                                    <span class="badge bg-dark bg-opacity-25 text-cyber">{{ 'spirit.level'|trans }} <span id="spirit-level">1</span></span>                                    
                                </div>
                                <div class="progress mt-3">
                                    <div id="spirit-experience-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
                                            role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" 
                                            style="width: 0%">
                                    </div>
                                </div>
                                <p class="text-start mt-1">
                                    <small>{{ 'spirit.experience'|trans }}: <span id="spirit-experience">0</span>/<span id="spirit-next-level">100</span></small>
                                </p>
                            </div>
                            <div style="clear:both;"></div>

                            {# Memory Explorer Section #}
                            <div class="mt-4 mb-4">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h5 class="mb-0">
                                        <i class="mdi mdi-brain text-cyber me-2"></i>{{ 'spirit.memory.title'|trans }}
                                    </h5>
                                    <a href="{{ path('spirit_memory_explorer', {spiritId: spiritId}) }}" class="btn btn-sm btn-outline-cyber" id="btn-open-memory-explorer">
                                        <i class="mdi mdi-arrow-expand-all me-1"></i>{{ 'spirit.memory.explore'|trans }}
                                    </a>
                                </div>
                                <div class="memory-graph-preview rounded" style="height: 250px; background: rgba(10, 10, 15, 0.6); position: relative;">
                                    <div id="profile-memory-loading" class="position-absolute top-50 start-50 translate-middle text-center" style="z-index: 10;">
                                        <div class="spinner-border spinner-border-sm text-cyber" role="status">
                                            <span class="visually-hidden">{{ 'ui.loading'|trans }}</span>
                                        </div>
                                        <p class="mt-2 small text-secondary">{{ 'spirit.memory.loading_graph'|trans }}</p>
                                    </div>
                                    <canvas id="profile-memory-canvas" class="rounded" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"></canvas>
                                </div>
                                <div class="d-flex justify-content-center align-items-center mt-2">
                                    <small class="text-secondary">
                                        <i class="mdi mdi-circle-multiple"></i>
                                        <span id="profile-stats-nodes">0</span> {{ 'spirit.memory.nodes'|trans }} Â· 
                                        <i class="mdi mdi-link-variant"></i>
                                        <span id="profile-stats-edges">0</span> {{ 'spirit.memory.relationships'|trans }}
                                    </small>
                                </div>
                            </div>

                            <h4>{{ 'spirit.spirit_detail.conversations'|trans }}</h4>
                            <div id="conversations-list">
                                <div class="spinner-border spinner-border-sm text-primary" role="status">
                                    <span class="visually-hidden">{{ 'ui.loading'|trans }}</span>
                                </div>
                                <span>{{ 'spirit.detail.loading_conversations'|trans }}</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-5">
                                <div class="form-group mb-3">
                                    <label for="spirit-ai-model" class="form-label"><i class="mdi mdi-brain me-2 text-cyber"></i>{{ 'spirit.settings.ai_model'|trans|default('AI Model') }}</label>
                                    <select id="spirit-ai-model" class="form-select" onchange="let saveBtn = document.getElementById('update-spirit-settings'); saveBtn.disabled = false;">
                                        <option value="">{{ 'spirit.settings.use_primary_model'|trans|default('Use Primary AI Model') }}</option>
                                        {% for model in aiModels %}
                                            <option value="{{ model.id }}" data-slug="{{ model.modelSlug }}" {% if spirit.settings.aiModel is defined and spirit.settings.aiModel == model.id %}selected{% endif %}>
                                                {{ model.modelName }} [{{ model.contextWindow|number_format(0, '.', ' ') }}] ({{ model.ppmInput|number_format(0, '.', ' ') }} / {{ model.ppmOutput|number_format(0, '.', ' ') }})
                                            </option>
                                        {% endfor %}
                                    </select>
                                    <div class="form-text text-muted ms-2">{{ 'spirit.settings.price_hint'|trans|default('model name [context window] (input price / output price) in Credits per million tokens') }}</div>
                                </div>
                                <div class="form-group mb-1">
                                    <label for="spirit-system-prompt" class="form-label"><i class="mdi mdi-message-text-outline me-2 text-cyber"></i>{{ 'spirit.settings.system_prompt'|trans|default('System Prompt') }}</label>
                                    <textarea id="spirit-system-prompt" class="form-control" rows="6" 
                                        placeholder="{{ 'spirit.settings.system_prompt_placeholder'|trans|default('Define how your Spirit should behave and what knowledge it should have...') }}" 
                                        oninput="let saveBtn = document.getElementById('update-spirit-settings'); saveBtn.disabled = false;"></textarea>
                                    <div class="form-text text-muted p-2">{{ 'spirit.settings.system_prompt_help'|trans|default('Define your Spirit\'s character, personality, and areas of expertise.') }}</div>
                                </div>
                                <div class="d-flex justify-content-between align-items-center me-2 mt-2">
                                    <button id="open-prompt-builder" class="btn btn-sm btn-outline-secondary ms-2" type="button">
                                        <i class="mdi mdi-code-braces me-1"></i>{{ 'spirit.prompt_builder.button'|trans|default('Advanced Prompt Builder') }}
                                    </button>
                                    <button id="update-spirit-settings" class="btn btn-sm btn-cyber" disabled><i class="mdi mdi-content-save me-2"></i>{{ 'ui.save'|trans|default('Save') }}</button>
                                </div>
                            </div>
                            <hr>
                            <h4 class="mt-4">{{ 'spirit.spirit_detail.interactions'|trans }}</h4>
                            <div id="spirit-interactions">
                                <div class="spinner-border spinner-border-sm text-primary" role="status">
                                    <span class="visually-hidden">{{ 'ui.loading'|trans }}</span>
                                </div>
                                <span>{{ 'spirit.detail.loading_interactions'|trans }}</span>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<div data-translations="{{ {}
    |merge({'spirit.no_interactions': 'No interactions recorded yet.'|trans})
    |merge({'error.loading_spirit': 'Failed to load spirit'|trans})
    |merge({'error.creating_spirit': 'Failed to create spirit'|trans})
    |merge({'error.interaction_failed': 'Failed to interact with spirit'|trans})
    |merge({'error.loading_interactions': 'Failed to load interactions'|trans})
    |merge({'spirit.prompt_builder.saved': 'Configuration saved successfully'|trans})
    |merge({'error.loading_prompt': 'Failed to load prompt data'|trans})
    |merge({'error.saving_config': 'Failed to save configuration'|trans})
    |merge({'ui.saving': 'Saving...'|trans})
    |merge({'ui.save': 'Save'|trans})
    |merge({'ui.copied': 'Copied to clipboard'|trans})
    |merge({'error.copy_failed': 'Failed to copy to clipboard'|trans})
    |merge({'spirit.prompt_builder.no_tools': 'No AI tools available'|trans})
    |json_encode|e('html_attr') }}">
</div>

{# System Prompt Builder Modal #}
{% include 'spirit/_system_prompt_builder_modal.html.twig' %}
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    {{ encore_entry_script_tags('spirit') }}
{% endblock %}
