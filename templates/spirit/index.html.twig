{% extends 'base.html.twig' %}

{% block title %}{{ 'spirit.title'|trans }}{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    {{ encore_entry_link_tags('spirit') }}
    {{ encore_entry_link_tags('ai-model-selector') }}
{% endblock %}

{% block body %}
<div class="container mt-3">
    <input type="hidden" id="spirit-id" value="{{ spiritId is defined ? spiritId : '' }}">
    <div class="glass-panel pt-4">
        {# <div class="text-white p-4">
            <h2 class="mb-0">{{ 'spirit.title'|trans }}</h2>
        </div> #}
        <div class="px-4 pb-4 pt-1 mb-2">
            <div id="spirit-container">
                <div class="text-center mb-4" id="spirit-loading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">{{ 'ui.loading'|trans }}</span>
                    </div>
                    <p class="mt-2">{{ 'spirit.detail.connecting'|trans }}</p>
                </div>
                
                <div id="spirit-display" class="d-none">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="w-50 float-start">
                                <div class="spirit-avatar-container big">
                                    <div id="spiritChatAvatar" class="spirit-avatar d-flex align-items-center justify-content-center text-secondary cursor-pointer" title="{{ 'spirit.chat.open'|trans|default('Open Spirit Chat') }}">
                                        <i class="mdi mdi-ghost spirit-detail-icon"></i>
                                    </div>
                                </div>
                            </div>
                            <div class="w-50 float-end">
                                <div class="text-start">
                                    <h3 id="spirit-name-display" class="mb-2">{{ 'spirit.name'|trans }}</h3>
                                    <span class="badge bg-dark bg-opacity-25 text-cyber">{{ 'spirit.level'|trans }} <span id="spirit-level">1</span></span>                                    
                                </div>
                                <div class="progress mt-3">
                                    <div id="spirit-experience-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
                                            role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" 
                                            style="width: 0%">
                                    </div>
                                </div>
                                <p class="text-start mt-1">
                                    <small>{{ 'spirit.experience'|trans }}: <span id="spirit-experience">0</span>/<span id="spirit-next-level">100</span></small>
                                </p>
                            </div>
                            <div style="clear:both;"></div>

                            {# Memory Explorer Section #}
                            <div class="mt-4 mb-2 glass-panel p-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h5 class="mb-0">
                                        <i class="mdi mdi-brain text-cyber me-2"></i>{{ 'spirit.memory.title'|trans }}
                                    </h5>
                                    <a href="{{ path('spirit_memory_explorer', {spiritId: spiritId}) }}" class="btn btn-sm btn-outline-cyber" id="btn-open-memory-explorer">
                                        <i class="mdi mdi-arrow-expand-all me-1"></i>{{ 'spirit.memory.explore'|trans }}
                                    </a>
                                </div>
                                <div class="memory-graph-preview rounded" style="height: 250px; background: rgba(10, 10, 15, 0.6); position: relative;">
                                    <div id="profile-memory-loading" class="position-absolute top-50 start-50 translate-middle text-center" style="z-index: 10;">
                                        <div class="spinner-border spinner-border-sm text-cyber" role="status">
                                            <span class="visually-hidden">{{ 'ui.loading'|trans }}</span>
                                        </div>
                                        <p class="mt-2 small text-secondary">{{ 'spirit.memory.loading_graph'|trans }}</p>
                                    </div>
                                    <canvas id="profile-memory-canvas" class="rounded" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"></canvas>
                                </div>
                                <div class="d-flex justify-content-center align-items-center mt-2">
                                    <small class="text-secondary">
                                        <i class="mdi mdi-circle-multiple"></i>
                                        <span id="profile-stats-nodes">0</span>x {{ 'spirit.memory.nodes'|trans }} &nbsp; · &nbsp; 
                                        <i class="mdi mdi-link-variant"></i>
                                        <span id="profile-stats-edges">0</span>x {{ 'spirit.memory.relationships'|trans }}
                                    </small>
                                </div>
                            </div>
                            
                        </div>
                        <div class="col-md-6">
                            <div class="glass-panel p-3 h-100">
                                <div class="form-group mb-3">
                                    <label for="spirit-ai-model" class="form-label"><i class="mdi mdi-robot-outline me-2 text-cyber"></i>{{ 'spirit.settings.ai_model'|trans|default('AI Model') }}</label>
                                    <input type="hidden" id="spirit-ai-model" value="{{ spirit.settings.aiModel ?? '' }}">
                                    <button type="button" class="btn btn-outline-cyber w-100 text-start d-flex justify-content-between align-items-center" id="spirit-ai-model-selector-btn">
                                        <span id="spirit-ai-model-display">
                                            {% if spirit.settings.aiModel is defined and spirit.settings.aiModel %}
                                                {% for model in aiModels %}
                                                    {% if model.id == spirit.settings.aiModel %}
                                                        {{ model.modelName }}
                                                    {% endif %}
                                                {% endfor %}
                                            {% else %}
                                                {{ 'spirit.settings.use_primary_model'|trans|default('Use Primary AI Model') }}
                                            {% endif %}
                                        </span>
                                        <i class="mdi mdi-chevron-down"></i>
                                    </button>
                                    <div class="form-text text-muted ms-2">{{ 'settings.ai.models.select_hint'|trans|default('Click to compare and select the best model for your needs') }}</div>
                                </div>
                                <div class="form-group mb-1">
                                    <label for="spirit-system-prompt" class="form-label"><i class="mdi mdi-message-text-outline me-2 text-cyber"></i>{{ 'spirit.settings.system_prompt'|trans|default('System Prompt') }}</label>
                                    <textarea id="spirit-system-prompt" class="form-control" rows="9" 
                                        placeholder="{{ 'spirit.settings.system_prompt_placeholder'|trans|default('Define how your Spirit should behave and what knowledge it should have...') }}" 
                                        oninput="let saveBtn = document.getElementById('update-spirit-settings'); saveBtn.disabled = false;"></textarea>
                                    <div class="form-text text-muted p-2">{{ 'spirit.settings.system_prompt_help'|trans|default('Define your Spirit\'s character, personality, and areas of expertise.') }}</div>
                                </div>
                                <div class="d-flex justify-content-between align-items-center me-2 mt-2">
                                    <button id="open-prompt-builder" class="btn btn-sm btn-outline-secondary ms-2" type="button">
                                        <i class="mdi mdi-code-braces me-1"></i>{{ 'spirit.prompt_builder.button'|trans|default('Advanced Prompt Builder') }}
                                    </button>
                                    <button id="update-spirit-settings" class="btn btn-sm btn-cyber" disabled><i class="mdi mdi-content-save me-2"></i>{{ 'ui.save'|trans|default('Save') }}</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6 mt-2 pe-1">
            <div class="glass-panel p-4">
                <h4 class="">{{ 'spirit.spirit_detail.interactions'|trans }}</h4>
                <div id="spirit-interactions" class="rounded">
                    {% if interactions is defined and interactions|length > 0 %}
                        <ul class="list-group list-group-flush bg-dark bg-opacity-25 rounded">
                            {% for interaction in interactions %}
                                <li class="list-group-item bg-transparent border-secondary border-opacity-25">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <small class="badge bg-success bg-opacity-50">+{{ interaction.experienceGained }} XP</small>
                                        </div>
                                        <div>
                                            <span class="badge bg-secondary bg-opacity-50 me-2">{{ interaction.type }}</span>
                                            {% if interaction.context %}
                                                <small class="text-muted">{{ interaction.context }}</small>
                                            {% endif %}
                                        </div>
                                        <div class="text-end">
                                            <small class="text-muted" style="font-size: xx-small;">{{ interaction.createdAt }}</small>
                                        </div>
                                    </div>
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p class="text-muted small">{{ 'spirit.no_interactions'|trans }}</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-md-6 mt-2 ps-1">
            <div class="glass-panel p-4">
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <div>
                        <h4 class="d-inline-block mb-0">
                            <i class="mdi mdi-forum-outline text-cyber me-2"></i>
                            {{ 'spirit.spirit_detail.conversations'|trans }}
                        </h4>
                        <span class="text-secondary ms-2">({{ conversations|length }})</span>
                    </div>
                    <button id="newConversationBtnProfile" class="btn btn-sm btn-cyber" title="{{ 'spirit.chat.new_conversation'|trans }}">
                        <i class="mdi mdi-message-plus"></i>
                    </button>
                </div>

                <div id="conversations-list" class="rounded">
                    {% if conversations is defined and conversations|length > 0 %}
                        <ul class="list-group list-group-flush bg-dark bg-opacity-50 rounded">
                            {% for conversation in conversations %}
                                <li class="list-group-item bg-transparent border-secondary border-opacity-25 cursor-pointer conversation-item" data-conversation-id="{{ conversation.id }}">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="w-100">
                                            <i class="mdi mdi-message-outline me-2 text-cyber"></i><strong>{{ conversation.title }}</strong>
                                            <br>
                                            <small class="text-muted">{{ conversation.messagesCount }} {{ 'spirit.messages'|trans|default('messages') }}</small>
                                        {# </div>
                                        <div class="text-end"> #}
                                            <small class="text-muted float-end">{{ conversation.lastInteraction }}</small>
                                        </div>
                                    </div>
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p class="text-muted small">{{ 'spirit.no_conversations'|trans|default('No conversations yet') }}</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {# All Spirits List #}
    <div class="row mt-5">
        <div class="col-12 glass-panel p-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4>
                    <a href="{{ path('spirits_index') }}">
                        <i class="mdi mdi-ghost me-2 text-cyber"></i>{{ 'spirits.title'|trans }}
                    </a>
                </h4>
            </div>
            <div class="row">
                {% if allSpirits is defined and allSpirits|length > 0 %}
                    {% for spirit in allSpirits %}
                        {% set progression = spirit.progression %}
                        {% set isPrimary = spirit.isPrimary %}
                        {% set spiritColor = spirit.color %}
                        
                        <div class="col-md-6 col-lg-4 mb-3">
                            <div class="card h-100 spirit-card glass-panel {{ isPrimary ? 'glass-panel-glow' : '' }}">
                                <a href="{{ path('spirit_show', {id: spirit.id}) }}" >
                                    <div class="card-body p-3">
                                        <div class="d-flex align-items-center mb-2">
                                            <div class="spirit-list-icon me-2" style="background-color: {{ spiritColor }}21;">
                                                <i class="mdi mdi-ghost" style="color: {{ spiritColor }};"></i>
                                            </div>
                                            <div class="flex-grow-1">
                                                <h6 class="mb-0">{{ spirit.name }}</h6>
                                                {% if isPrimary %}
                                                    <small class="text-muted">{{ 'spirits.primary'|trans }}</small>
                                                    <span class="badge bg-dark bg-opacity-25 ms-2 text-warning">★</span>
                                                {% else %}
                                                    <small class="text-muted">{{ 'spirits.spirit'|trans }}</small>
                                                {% endif %}
                                            </div>
                                        </div>
                                        
                                        <div class="">
                                            <div class="d-flex justify-content-between mb-1">
                                                <small class="fw-bold">{{ 'spirits.level'|trans }} {{ progression.level|default(1) }}</small>
                                                <small class="text-muted">{{ progression.experience|default(0) }} XP</small>
                                            </div>
                                            <div class="progress" style="height: 4px;">
                                                <div class="progress-bar bg-cyber" role="progressbar" style="width: {{ progression.percentage|default(0) }}%"></div>
                                            </div>
                                        </div>
                                    </div>
                                </a>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="col-12 text-center text-secondary small py-3">
                        <i class="mdi mdi-ghost-outline"></i>
                        <p class="mt-1 mb-0">{{ 'spirits.no_spirits'|trans|default('No spirits yet') }}</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div data-translations="{{ {}
    |merge({'spirit.no_interactions': 'No interactions recorded yet.'|trans})
    |merge({'error.loading_spirit': 'Failed to load spirit'|trans})
    |merge({'error.creating_spirit': 'Failed to create spirit'|trans})
    |merge({'error.interaction_failed': 'Failed to interact with spirit'|trans})
    |merge({'error.loading_interactions': 'Failed to load interactions'|trans})
    |merge({'spirit.prompt_builder.saved': 'Configuration saved successfully'|trans})
    |merge({'error.loading_prompt': 'Failed to load prompt data'|trans})
    |merge({'error.saving_config': 'Failed to save configuration'|trans})
    |merge({'ui.saving': 'Saving...'|trans})
    |merge({'ui.save': 'Save'|trans})
    |merge({'ui.copied': 'Copied to clipboard'|trans})
    |merge({'error.copy_failed': 'Failed to copy to clipboard'|trans})
    |merge({'spirit.prompt_builder.no_tools': 'No AI tools available'|trans})
    |json_encode|e('html_attr') }}">
</div>

{# System Prompt Builder Modal #}
{% include 'spirit/_system_prompt_builder_modal.html.twig' %}

{# AI Model Selector Modal #}
{% include 'components/_ai_model_selector.html.twig' %}
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    {{ encore_entry_script_tags('spirit') }}
    {{ encore_entry_script_tags('ai-model-selector') }}
    <script>
        // Initialize AI Model Selector for Spirit
        document.addEventListener('DOMContentLoaded', function() {
            const spiritModelBtn = document.getElementById('spirit-ai-model-selector-btn');
            const saveBtn = document.getElementById('update-spirit-settings');

            if (spiritModelBtn) {
                spiritModelBtn.addEventListener('click', function() {
                    const currentModelId = document.getElementById('spirit-ai-model').value;
                    window.aiModelSelector.open('primary', function(model) {
                        // Update hidden input
                        document.getElementById('spirit-ai-model').value = model.id;
                        // Update display
                        const displayText = model.modelName || '{{ 'spirit.settings.use_primary_model'|trans|default('Use Primary AI Model') }}';
                        document.getElementById('spirit-ai-model-display').textContent = displayText;
                        // Enable save button
                        if (saveBtn) {
                            saveBtn.disabled = false;
                        }
                    }, currentModelId || null);
                });
            }
        });
    </script>
{% endblock %}
