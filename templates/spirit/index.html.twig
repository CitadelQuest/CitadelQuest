{% extends 'base.html.twig' %}

{% block title %}{{ 'spirit.title'|trans }}{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    {{ encore_entry_link_tags('spirit') }}
{% endblock %}

{% block body %}
<div class="container mt-4">
    <input type="hidden" id="spirit-id" value="{{ spiritId is defined ? spiritId : '' }}">
    <div class="glass-panel pt-4">
        {# <div class="text-white p-4">
            <h2 class="mb-0">{{ 'spirit.title'|trans }}</h2>
        </div> #}
        <div class="px-4 pb-4 pt-1">
            <div id="spirit-container">
                <div class="text-center mb-4" id="spirit-loading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">{{ 'ui.loading'|trans }}</span>
                    </div>
                    <p class="mt-2">{{ 'spirit.detail.connecting'|trans }}</p>
                </div>
                
                <div id="spirit-display" class="d-none">
                    <div class="row">
                        <div class="col-md-5">
                                <div class="spirit-avatar-container big">
                                    <div id="spiritChatAvatar" class="spirit-avatar d-flex align-items-center justify-content-center text-secondary">
                                        <i class="mdi mdi-ghost spirit-detail-icon"></i>
                                    </div>
                                </div>
                            <div class="text-center mt-5">
                                <h3 id="spirit-name-display" class="mb-2">{{ 'spirit.name'|trans }}</h3>
                                <div class="d-flex justify-content-center align-items-center">
                                    <span class="badge bg-primary">{{ 'spirit.level'|trans }} <span id="spirit-level">1</span></span>
                                </div>
                            </div>
                            <div class="progress mt-3">
                                <div id="spirit-experience-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
                                        role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" 
                                        style="width: 0%">
                                </div>
                            </div>
                            <p class="text-center mt-1">
                                <small>{{ 'spirit.experience'|trans }}: <span id="spirit-experience">0</span>/<span id="spirit-next-level">100</span></small>
                            </p>

                            <h4>{{ 'spirit.spirit_detail.interactions'|trans }}</h4>
                            <div id="spirit-interactions">
                                <div class="spinner-border spinner-border-sm text-primary" role="status">
                                    <span class="visually-hidden">{{ 'ui.loading'|trans }}</span>
                                </div>
                                <span>{{ 'spirit.detail.loading_interactions'|trans }}</span>
                            </div>
                        </div>
                        <div class="col-md-7">
                            <h4>{{ 'spirit.settings.title'|trans|default('Settings') }}</h4>
                            <div class="mb-4">
                                <div class="form-group mb-3">
                                    <label for="spirit-ai-model" class="form-label"><i class="mdi mdi-brain me-2 text-cyber"></i>{{ 'spirit.settings.ai_model'|trans|default('AI Model') }}</label>
                                    <select id="spirit-ai-model" class="form-select" onchange="let saveBtn = document.getElementById('update-spirit-settings'); saveBtn.disabled = false;">
                                        <option value="">{{ 'spirit.settings.use_primary_model'|trans|default('Use Primary AI Model') }}</option>
                                        {% for model in aiModels %}
                                            <option value="{{ model.id }}" data-slug="{{ model.modelSlug }}" {% if spirit.settings.aiModel is defined and spirit.settings.aiModel == model.id %}selected{% endif %}>
                                                {{ model.modelName }} [{{ model.contextWindow|number_format(0, '.', ' ') }}] ({{ model.ppmInput|number_format(0, '.', ' ') }} / {{ model.ppmOutput|number_format(0, '.', ' ') }})
                                            </option>
                                        {% endfor %}
                                    </select>
                                    <div class="form-text text-muted ms-2">{{ 'spirit.settings.price_hint'|trans|default('model name [context window] (input price / output price) in Credits per million tokens') }}</div>
                                </div>
                                <div class="form-group">
                                    <label for="spirit-system-prompt" class="form-label"><i class="mdi mdi-message-text-outline me-2 text-cyber"></i>{{ 'spirit.settings.system_prompt'|trans|default('System Prompt') }}</label>
                                    <textarea id="spirit-system-prompt" class="form-control" rows="6" 
                                        placeholder="{{ 'spirit.settings.system_prompt_placeholder'|trans|default('Define how your Spirit should behave and what knowledge it should have...') }}" 
                                        oninput="let saveBtn = document.getElementById('update-spirit-settings'); saveBtn.disabled = false;"></textarea>
                                    <div class="form-text text-muted p-2">{{ 'spirit.settings.system_prompt_help'|trans|default('Define your Spirit\'s character, personality, and areas of expertise.') }}</div>
                                </div>
                                <div class="text-end me-2 mt-2">
                                    <button id="update-spirit-settings" class="btn btn-sm btn-cyber" disabled><i class="mdi mdi-content-save me-2"></i>{{ 'ui.save'|trans|default('Save') }}</button>
                                </div>
                            </div>
                            <h4 class="mt-5">{{ 'spirit.spirit_detail.conversations'|trans }}</h4>
                            <div id="conversations-list">
                                <div class="spinner-border spinner-border-sm text-primary" role="status">
                                    <span class="visually-hidden">{{ 'ui.loading'|trans }}</span>
                                </div>
                                <span>{{ 'spirit.detail.loading_conversations'|trans }}</span>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<div data-translations="{{ {}
    |merge({'spirit.no_interactions': 'No interactions recorded yet.'|trans})
    |merge({'error.loading_spirit': 'Failed to load spirit'|trans})
    |merge({'error.creating_spirit': 'Failed to create spirit'|trans})
    |merge({'error.interaction_failed': 'Failed to interact with spirit'|trans})
    |merge({'error.loading_interactions': 'Failed to load interactions'|trans})
    |json_encode|e('html_attr') }}">
</div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    {{ encore_entry_script_tags('spirit') }}
{% endblock %}
