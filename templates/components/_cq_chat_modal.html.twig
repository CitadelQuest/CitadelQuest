{% if app.user %}
<div class="modal fade" id="cqChatModal" tabindex="-1" aria-labelledby="cqChatModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-fullscreen">
        <div class="modal-content glass-panel_" style="background-color: var(--bs-gray-800) !important;">
            <div class="modal-header bg-cyber-g border-0 py-2 flex-column align-items-stretch">
                <div class="d-flex align-items-center w-100">
                    <i class="mdi mdi-forum text-cyber fs-5 me-2"></i>
                    <span class="modal-title flex-grow-1" id="cqChatModalLabel">
                        <span id="cqChatModalTitle" class="text-light"></span>
                    </span>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ 'ui.close'|trans }}"></button>
                </div>
            </div>
            <div class="modal-header bg-dark bg-opacity-50 border-success py-2 flex-column align-items-stretch">
                <div id="cqChatMembers" class="d-none d-flex flex-wrap gap-1"></div>
            </div>
            <div class="modal-body pt-0 d-flex flex-column mx-0 px-0 pb-0" style="height: calc(100vh - 200px);">
                <div id="cqChatMessages" class="flex-grow-1 overflow-auto px-2 pt-3 d-block">
                    <div class="text-center p-3 loading-indicator">
                        <div class="spinner-border text-cyber" role="status">
                            <span class="visually-hidden">{{ 'auth.key_generation.loading'|trans }}</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-secondary border-opacity-50 flex-column p-2 position-relative">
                {# Sending overlay #}
                <div id="cqChatSendingOverlay" class="d-none position-absolute top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center bg-dark bg-opacity-50" style="z-index: 10; border-radius: inherit;">
                    <div class="spinner-border text-cyber" role="status">
                        <span class="visually-hidden">{{ 'auth.key_generation.loading'|trans }}</span>
                    </div>
                </div>
                
                {# Image preview area #}
                <div id="cqChatImagePreview" class="w-100 d-none d-flex flex-wrap gap-2 mb-2 p-2 border border-secondary border-opacity-25 rounded"></div>
                
                <form id="cqChatForm" class="d-flex w-100 gap-2 align-items-top">
                    {# Hidden file input #}
                    <input type="file" id="cqChatImageUpload" accept="image/*" class="d-none" multiple>
                    
                    {# Upload button #}
                    <button type="button" id="cqChatImageUploadBtn" class="btn btn-outline-secondary" title="{{ 'file_browser.upload'|trans }}">
                        <i class="mdi mdi-image-plus"></i>
                    </button>
                    
                    <textarea id="cqChatMessageInput" class="form-control" rows="2" placeholder="{{ 'cq_chat.type_message'|trans }}" autocomplete="off"></textarea>
                    <button type="submit" id="cqChatSendBtn" class="btn btn-cyber">
                        <i class="mdi mdi-send"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- New Chat Modal -->
<div class="modal fade" id="cqChatNewChatModal" tabindex="-1" aria-labelledby="cqChatNewChatModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content glass-panel">
            <div class="modal-header bg-cyber-g border-success">
                <h5 class="modal-title" id="cqChatNewChatModalLabel">
                    <i class="mdi mdi-message-plus me-2"></i>{{ 'cq_chat.new_chat'|trans }}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ 'ui.close'|trans }}"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="cqChatNewChatContact" class="form-label">{{ 'cq_chat.select_contact'|trans }}</label>
                    <select id="cqChatNewChatContact" class="form-select">
                        <option value="">{{ 'cq_chat.loading_contacts'|trans }}</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="mdi mdi-close me-2"></i>{{ 'ui.cancel'|trans }}
                </button>
                <button type="button" id="cqChatNewChatConfirmBtn" class="btn btn-cyber">
                    <i class="mdi mdi-check me-2"></i>{{ 'cq_chat.start_chat'|trans }}
                </button>
            </div>
        </div>
    </div>
</div>

<!-- New Group Chat Modal -->
<div class="modal fade" id="cqChatNewGroupModal" tabindex="-1" aria-labelledby="cqChatNewGroupModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content glass-panel">
            <div class="modal-header bg-cyber-g border-success">
                <h5 class="modal-title" id="cqChatNewGroupModalLabel">
                    <i class="mdi mdi-message-plus me-2"></i>{{ 'cq_chat.new_group_chat'|trans }}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ 'ui.close'|trans }}"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="cqChatGroupName" class="form-label"><i class="mdi mdi-label me-2 text-cyber"></i>{{ 'cq_chat.group_name'|trans }}</label>
                    <input type="text" id="cqChatGroupName" class="form-control glass-input" placeholder="{{ 'cq_chat.enter_group_name'|trans }}" autocomplete="off">
                </div>
                <div class="mb-3">
                    <label class="form-label"><i class="mdi mdi-account-multiple-plus me-2 text-cyber"></i>{{ 'cq_chat.select_members'|trans }}</label>
                    <div id="cqChatGroupMembersList" class="border border-secondary rounded p-3 cyber-scrollbar" style="max-height: 300px; overflow-y: auto;">
                        <div class="text-center text-muted">
                            <i class="mdi mdi-loading mdi-spin"></i> {{ 'cq_chat.loading_contacts'|trans }}
                        </div>
                    </div>
                </div>
                <div id="cqChatGroupSelectedMembers" class="mb-2">
                    <small class="text-muted">{{ 'cq_chat.selected'|trans }}: <span id="cqChatGroupSelectedCount">0</span></small>
                </div>
            </div>
            <div class="modal-footer justify-content-between">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="mdi mdi-close me-2"></i>{{ 'ui.cancel'|trans }}
                </button>
                <button type="button" id="cqChatNewGroupConfirmBtn" class="btn btn-cyber">
                    <i class="mdi mdi-check me-2"></i>{{ 'cq_chat.create_group'|trans }}
                </button>
            </div>
        </div>
    </div>
</div>

<style>
/* CQ Chat styling (matching original cq_chat/view.html.twig) */
.chat-message {
    margin-bottom: 1rem;
    display: flex;
}

.chat-message.chat-message-user {
    justify-content: flex-end;
}

.chat-message.chat-message-user .chat-bubble {
    background-color: rgba(149, 236, 134, 0.3);
    border-radius: 1rem 1rem 0 1rem;
}

.chat-message.chat-message-assistant {
    justify-content: flex-start;
}

.chat-message.chat-message-assistant .chat-bubble {
    background-color: rgba(33, 37, 41, 0.5);
    border-radius: 1rem 1rem 1rem 0;
}

.chat-bubble {
    /* max-width: 70%; */
    padding: 0.75rem 1rem;
    position: relative;
    overflow: auto;
}

.chat-content {
    word-break: break-word;
}

/* Markdown styling in chat messages */
.chat-content p {
    margin-bottom: 0.5rem;
}

.chat-content p:last-child {
    margin-bottom: 0;
}

.chat-content pre {
    background-color: rgba(0, 0, 0, 0.3);
    border-radius: 0.5rem;
    padding: 0.75rem;
    margin: 0.5rem 0;
    overflow-x: auto;
}

.chat-content code {
    font-family: 'Fira Code', 'Monaco', 'Consolas', monospace;
    font-size: 0.85em;
}

.chat-content pre code {
    background: none;
    padding: 0;
    color: #95ec86;
}

.chat-content :not(pre) > code {
    background-color: rgba(0, 0, 0, 0.3);
    padding: 0.15rem 0.4rem;
    border-radius: 0.25rem;
    color: #95ec86;
}

.chat-content a {
    color: #95ec86;
    text-decoration: underline;
}

.chat-content ul, .chat-content ol {
    margin: 0.5rem 0;
    padding-left: 1.5rem;
}

.chat-content blockquote {
    border-left: 3px solid #95ec86;
    padding-left: 0.75rem;
    margin: 0.5rem 0;
    opacity: 0.8;
}

.chat-timestamp {
    font-size: 0.7rem;
    opacity: 0.7;
    text-align: right;
    margin-top: 0.25rem;
}

/* Image preview in input area */
#cqChatImagePreview .preview-item {
    position: relative;
    display: inline-block;
}

#cqChatImagePreview .preview-item img {
    max-height: 80px;
    max-width: 120px;
    border-radius: 0.5rem;
    object-fit: cover;
}

#cqChatImagePreview .preview-item .remove-btn {
    position: absolute;
    top: -8px;
    right: -8px;
    cursor: pointer;
    font-size: 0.75rem;
    padding: 0.15rem 0.35rem;
}

/* Images in chat messages */
.chat-attachments {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
}

.chat-attachments .content-showcase {
    position: relative;
}

.chat-attachments .chat-attachment-img {
    max-width: 250px;
    max-height: 200px;
    border-radius: 0.5rem;
    cursor: default;
    transition: transform 0.2s;
}

.chat-attachments .content-showcase-icon {
    opacity: 1;
}
</style>
{% endif %}
