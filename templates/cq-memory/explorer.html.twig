{% extends 'base.html.twig' %}

{% block title %}{{ 'spirit.memory.title'|trans }}{% if spirit %} - {{ spirit.name }}{% endif %}{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    {{ encore_entry_link_tags('cq-memory') }}
{% endblock %}

{% block body %}
<div class="container-fluid memory-explorer">
    {% if spiritId %}
    <input type="hidden" id="spirit-id" value="{{ spiritId }}">
    <input type="hidden" id="spirit-name" value="{{ spirit.name }}">
    {% endif %}
    {% if libPath %}
    <input type="hidden" id="lib-path" value="{{ libPath }}">
    {% endif %}
    
    <div class="row">
        <div class="col-12">
            <div class="glass-panel mb-2">
                <div class="d-flex justify-content-between align-items-center p-2">
                    <div class="d-flex align-items-center">
                        {% if spirit %}
                        <a href="{{ path('spirit_show', {id: spiritId}) }}" class="link-secondary me-3">
                            <i class="mdi mdi-arrow-left"></i>
                        </a>
                        {% else %}
                        <a href="{{ path('app_dashboard') }}" class="link-secondary me-3">
                            <i class="mdi mdi-arrow-left"></i>
                        </a>
                        {% endif %}
                        <div class="mb-0">
                            <i class="mdi mdi-graph text-cyber me-2"></i>
                            <span class="d-none d-lg-inline">{{ 'spirit.memory.title'|trans }}{% if spirit %} <br> <span class="small text-cyber"><i class="mdi mdi-ghost me-1"></i> {{ spirit.name }}</span>{% endif %}</span>
                        </div>
                    </div>
                    <div class="d-flex align-items-end gap-2 flex-sm-row flex-column">
                        {# Library Selector #}
                        <div class="d-flex align-items-center">
                            <label class="form-label small text-secondary mb-0 me-2 d-none d-md-inline">
                                <i class="mdi mdi-bookshelf"></i>
                            </label>
                            <select id="library-selector" class="form-select form-select-sm bg-dark text-light border-secondary" style="min-width: 160px;">
                                <option value="">{{ 'spirit.memory.library_selector.all_packs'|trans|default('All Packs') }}</option>
                            </select>
                            <div class="dropdown ms-1">
                                <button class="btn btn-sm btn-outline-cyber dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" title="{{ 'spirit.memory.library_selector.menu'|trans|default('Library options') }}">
                                    <i class="mdi mdi-dots-vertical"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-dark dropdown-menu-end">
                                    <li><a class="dropdown-item" href="#" id="btn-create-library"><i class="mdi mdi-plus me-2 text-cyber"></i>{{ 'spirit.memory.library_selector.create_new'|trans|default('Create new library') }}</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="#" id="btn-library-details"><i class="mdi mdi-information-outline me-2 text-cyber"></i>{{ 'spirit.memory.library_selector.details'|trans|default('Details') }}</a></li>
                                    <li><a class="dropdown-item text-danger" href="#" id="btn-delete-library"><i class="mdi mdi-delete-outline me-2"></i>{{ 'spirit.memory.library_selector.delete'|trans|default('Delete') }}</a></li>
                                </ul>
                            </div>
                        </div>
                        {# Pack Selector #}
                        <div class="d-flex align-items-center ms-2">
                            <label class="form-label small text-secondary mb-0 me-2 d-none d-md-inline">
                                <i class="mdi mdi-package-variant"></i>
                            </label>
                            <select id="pack-selector" class="form-select form-select-sm bg-dark text-light border-secondary" style="min-width: 180px;">
                                <option value="">-- {{ 'spirit.memory.pack_selector.loading'|trans|default('Loading packs...') }} --</option>
                            </select>
                            <div class="dropdown ms-1">
                                <button class="btn btn-sm btn-outline-cyber dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" title="{{ 'spirit.memory.pack_selector.menu'|trans|default('Pack options') }}">
                                    <i class="mdi mdi-dots-vertical"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-dark dropdown-menu-end">
                                    <li><a class="dropdown-item" href="#" id="btn-create-pack"><i class="mdi mdi-plus me-2 text-cyber"></i>{{ 'spirit.memory.pack_selector.create_new'|trans|default('Create new pack') }}</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="#" id="btn-pack-details"><i class="mdi mdi-information-outline me-2 text-cyber"></i>{{ 'spirit.memory.pack_selector.details'|trans|default('Details') }}</a></li>
                                    <li><a class="dropdown-item" href="#" id="btn-add-pack-to-lib"><i class="mdi mdi-book-plus-outline me-2 text-cyber"></i>{{ 'spirit.memory.pack_selector.add_to_lib'|trans|default('Add to Library') }}</a></li>
                                    <li><a class="dropdown-item" href="#" id="btn-remove-pack-from-lib"><i class="mdi mdi-book-remove-outline me-2 text-warning"></i>{{ 'spirit.memory.pack_selector.remove_from_lib'|trans|default('Remove from Library') }}</a></li>
                                    <li><a class="dropdown-item text-danger" href="#" id="btn-delete-pack"><i class="mdi mdi-delete-outline me-2"></i>{{ 'spirit.memory.pack_selector.delete'|trans|default('Delete') }}</a></li>
                                </ul>
                            </div>
                        </div>
                        
                        <div id="memory-stats" class="d-none d-md-flex flex-column gap-1 ms-2">
                            <span class="opacity-50 text-end nowrap" style="font-size: 0.6rem;">
                                <i class="mdi mdi-circle-multiple text-cyber opacity-50"></i>
                                <span id="stats-nodes">0</span>x&nbsp;{{ 'spirit.memory.nodes'|trans }}
                                <br>
                                <i class="mdi mdi-link-variant text-cyber opacity-50"></i>
                                <span id="stats-edges">0</span>x&nbsp;{{ 'spirit.memory.relationships'|trans }}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-4 col-sm-4 pe-0">
            <div class="glass-panel p-0 memory-panel left-tabbed-panel">
                {# Tab Navigation #}
                <ul class="nav nav-tabs memory-tabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="tab-search" data-bs-toggle="tab" data-bs-target="#panel-search" type="button" role="tab" aria-controls="panel-search" aria-selected="false">
                            <i class="mdi mdi-magnify"></i>
                            <span class="tab-label">{{ 'spirit.memory.search_panel.title'|trans|default('Search') }}</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="tab-compilation" data-bs-toggle="tab" data-bs-target="#panel-compilation" type="button" role="tab" aria-controls="panel-compilation" aria-selected="true">
                            <i class="mdi mdi-file-document-multiple"></i>
                            <span class="tab-label">{{ 'spirit.memory.compilation'|trans }}</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="tab-extraction" data-bs-toggle="tab" data-bs-target="#panel-extraction" type="button" role="tab" aria-controls="panel-extraction" aria-selected="false">
                            <i class="mdi mdi-excavator"></i><span class="text-secondary"> / </span><i class="mdi mdi-graph"></i>
                            <span class="tab-label">{{ 'spirit.memory.extract_panel.tab_extract_analyze'|trans }}</span>
                        </button>
                    </li>
                </ul>

                {# Tab Content #}
                <div class="tab-content p-3 pb-0 pt-2">
                    {# Search Tab #}
                    <div class="tab-pane fade" id="panel-search" role="tabpanel" aria-labelledby="tab-search">
                        <div class="mb-3">
                            <div class="input-group input-group-sm">
                                <span class="input-group-text bg-dark border-secondary text-cyber">
                                    <i class="mdi mdi-magnify"></i>
                                </span>
                                <input type="text" id="memory-search-input" class="form-control form-control-sm bg-dark text-light border-secondary" placeholder="{{ 'spirit.memory.search_panel.placeholder'|trans|default('Search memories...') }}" autocomplete="off">
                                <button id="memory-search-clear" class="btn btn-sm btn-outline-secondary d-none" type="button" title="Clear">
                                    <i class="mdi mdi-close"></i>
                                </button>
                            </div>
                            <div class="d-flex align-items-center justify-content-between mt-2">
                                <select id="memory-search-category" class="form-select form-select-sm bg-dark text-light border-secondary" style="max-width: 160px;">
                                    <option value="">{{ 'spirit.memory.search_panel.all_categories'|trans|default('All categories') }}</option>
                                    <option value="conversation">conversation</option>
                                    <option value="knowledge">knowledge</option>
                                    <option value="preference">preference</option>
                                    <option value="thought">thought</option>
                                    <option value="fact">fact</option>
                                </select>
                                <small id="memory-search-status" class="text-secondary text-end"></small>
                            </div>
                        </div>

                        <div id="memory-search-results" class="memory-search-results">
                            <div id="memory-search-placeholder" class="text-center text-secondary py-4 placeholder-state">
                                <i class="mdi mdi-text-search" style="font-size: 2.5rem; opacity: 0.3;"></i>
                                <p class="mt-2 small">{{ 'spirit.memory.search_panel.hint'|trans|default('Type to search across all memories in this pack. Uses FTS5 full-text search with relevance ranking.') }}</p>
                            </div>
                            <div id="memory-search-loading" class="text-center py-4 d-none">
                                <div class="spinner-border spinner-border-sm text-cyber" role="status"></div>
                                <span class="ms-2 small text-secondary">{{ 'spirit.memory.search_panel.searching'|trans|default('Searching...') }}</span>
                            </div>
                            <div id="memory-search-list"></div>
                        </div>
                    </div>

                    {# Compilation Tab #}
                    <div class="tab-pane fade show active" id="panel-compilation" role="tabpanel" aria-labelledby="tab-compilation">
                        <div id="compilation-placeholder" class="text-center text-secondary py-5 placeholder-state">
                            <i class="mdi mdi-selection-ellipse placeholder-icon"></i>
                            <p class="mt-2">{{ 'spirit.memory.select_for_compilation'|trans }}</p>
                        </div>
                        
                        <div id="compilation-content" class="d-none">
                            <div id="compilation-selected" class="mb-3">
                                <label class="form-label small text-cyber d-flex align-items-center">
                                    <i class="mdi mdi-star me-1"></i>
                                    {{ 'spirit.memory.selected_memory'|trans }}
                                </label>
                                <div id="compilation-selected-content" class="small p-2 rounded compilation-selected"></div>
                            </div>
                            
                            <div id="compilation-related">
                            </div>
                        </div>
                    </div>

                    {# Extraction Tab #}
                    <div class="tab-pane fade" id="panel-extraction" role="tabpanel" aria-labelledby="tab-extraction">

                        {# Sub-tab navigation: Extract | Analyze #}
                        <ul class="nav nav-tabs nav-tabs-sm mb-3" id="extract-analyze-tabs" role="tablist" style="font-size:0.85rem;">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active px-3 py-1" id="sub-tab-extract" data-bs-toggle="tab" data-bs-target="#sub-panel-extract" type="button" role="tab">
                                    <i class="mdi mdi-excavator me-1"></i>{{ 'spirit.memory.extract_panel.tab_extract'|trans }}
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link px-3 py-1" id="sub-tab-analyze" data-bs-toggle="tab" data-bs-target="#sub-panel-analyze" type="button" role="tab">
                                    <i class="mdi mdi-graph me-1"></i>{{ 'spirit.memory.extract_panel.tab_analyze'|trans }}
                                </button>
                            </li>
                        </ul>

                        <div class="tab-content">

                        {# Extract sub-panel #}
                        <div class="tab-pane fade show active" id="sub-panel-extract" role="tabpanel">
                        {# Source type selector pills #}
                        <div class="mb-3">
                            <label class="form-label small text-cyber mb-2">
                                <i class="mdi mdi-database-import me-1"></i>
                                {{ 'spirit.memory.extract_panel.source_type'|trans }}
                            </label>
                            <ul class="nav nav-pills extract-source-tabs mb-2" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active px-2 py-1 small" id="source-tab-file" data-bs-toggle="pill" data-bs-target="#source-panel-file" type="button" role="tab">
                                        <i class="mdi mdi-file-document me-1"></i>{{ 'spirit.memory.extract_panel.source_file'|trans }}
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link px-2 py-1 small" id="source-tab-url" data-bs-toggle="pill" data-bs-target="#source-panel-url" type="button" role="tab">
                                        <i class="mdi mdi-web me-1"></i>{{ 'spirit.memory.extract_panel.source_url'|trans }}
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link px-2 py-1 small" id="source-tab-text" data-bs-toggle="pill" data-bs-target="#source-panel-text" type="button" role="tab">
                                        <i class="mdi mdi-text-box me-1"></i>{{ 'spirit.memory.extract_panel.source_text'|trans }}
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link px-2 py-1 small" id="source-tab-conversation" data-bs-toggle="pill" data-bs-target="#source-panel-conversation" type="button" role="tab">
                                        <i class="mdi mdi-forum me-1"></i>{{ 'spirit.memory.extract_panel.source_conversation'|trans }}
                                    </button>
                                </li>
                            </ul>
                            <div class="tab-content">
                                {# File source panel #}
                                <div class="tab-pane fade show active" id="source-panel-file" role="tabpanel">
                                    <select id="extract-file-selector" class="form-select form-select-sm bg-dark text-light border-secondary">
                                        <option value="">-- {{ 'spirit.memory.extract_panel.select_file'|trans }} --</option>
                                    </select>
                                    <div class="small text-secondary mt-1">
                                        {{ 'spirit.memory.extract_panel.selected'|trans }}: <span id="extract-selected-file" class="text-cyber">None</span>
                                    </div>
                                </div>
                                {# URL source panel #}
                                <div class="tab-pane fade" id="source-panel-url" role="tabpanel">
                                    <input type="url" id="extract-url-input" class="form-control form-control-sm bg-dark text-light border-secondary" placeholder="https://example.com/article">
                                    <div class="small text-secondary mt-1">
                                        <i class="mdi mdi-information-outline me-1"></i>{{ 'spirit.memory.extract_panel.url_hint'|trans }}
                                    </div>
                                </div>
                                {# Text source panel #}
                                <div class="tab-pane fade" id="source-panel-text" role="tabpanel">
                                    <textarea id="extract-text-input" class="form-control form-control-sm bg-dark text-light border-secondary" rows="4" placeholder="{{ 'spirit.memory.extract_panel.text_placeholder'|trans }}"></textarea>
                                    <div class="small text-secondary mt-1 d-flex justify-content-between">
                                        <span><i class="mdi mdi-information-outline me-1"></i>{{ 'spirit.memory.extract_panel.text_hint'|trans }}</span>
                                        <span id="extract-text-charcount" class="text-cyber">0</span>
                                    </div>
                                </div>
                                {# Conversation source panel #}
                                <div class="tab-pane fade" id="source-panel-conversation" role="tabpanel">
                                    <select id="extract-spirit-selector" class="form-select form-select-sm bg-dark text-light border-secondary mb-2">
                                        <option value="">-- {{ 'spirit.memory.extract_panel.select_spirit'|trans }} --</option>
                                    </select>
                                    <select id="extract-conversation-selector" class="form-select form-select-sm bg-dark text-light border-secondary" disabled>
                                        <option value="">-- {{ 'spirit.memory.extract_panel.select_conversation'|trans }} --</option>
                                    </select>
                                    <div class="small text-secondary mt-1">
                                        <i class="mdi mdi-information-outline me-1"></i>{{ 'spirit.memory.extract_panel.conversation_hint'|trans }}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label small text-cyber d-flex justify-content-between">
                                <span>
                                    <i class="mdi mdi-layers-triple me-1"></i>
                                    {{ 'spirit.memory.extract_panel.max_depth'|trans }}
                                </span>
                                <span id="extract-max-depth-value" class="badge fw-normal bg-secondary bg-opacity-25">3</span>
                            </label>
                            <input type="range" class="form-range-input w-100" id="extract-max-depth" min="1" max="5" value="3">
                            <div class="d-flex justify-content-between small text-secondary">
                                <span>1 ({{ 'spirit.memory.extract_panel.depth_fast'|trans }})</span>
                                <span>5 ({{ 'spirit.memory.extract_panel.depth_deep'|trans }})</span>
                            </div>
                        </div>
                        
                        {# Auto-analyze toggle #}
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" role="switch" id="toggle-auto-analyze" checked>
                            <label class="form-check-label small text-secondary" for="toggle-auto-analyze">
                                <i class="mdi mdi-graph me-1 text-cyber opacity-50"></i>{{ 'spirit.memory.extract_panel.auto_analyze_label'|trans }}
                            </label>
                        </div>

                        <button id="btn-start-extraction" class="btn btn-sm btn-cyber w-100 mb-5" disabled>
                            <i class="mdi mdi-excavator"></i> {{ 'spirit.memory.extract_panel.start_extraction'|trans }}
                        </button>
                        </div>{# /sub-panel-extract #}

                        {# Analyze sub-panel #}
                        <div class="tab-pane fade" id="sub-panel-analyze" role="tabpanel">
                            <div class="mb-3">
                                <p class="small text-secondary mb-3">
                                    <i class="mdi mdi-information-outline me-1 text-cyber opacity-50"></i>
                                    {{ 'spirit.memory.extract_panel.analyze_description'|trans }}
                                </p>
                                <button id="btn-start-analysis" class="btn btn-sm btn-cyber w-100 mb-4" disabled>
                                    <i class="mdi mdi-graph me-1"></i> {{ 'spirit.memory.extract_panel.start_analysis'|trans }}
                                </button>
                                <div id="analyze-alert" class="mt-2 d-none"></div>
                            </div>
                        </div>{# /sub-panel-analyze #}

                        </div>{# /tab-content #}

                        {# Active Jobs — shared between both sub-panels #}
                        <h6 class="small text-cyber mb-2">
                            <i class="mdi mdi-progress-clock me-1"></i>
                            {{ 'spirit.memory.extract_panel.active_jobs'|trans }}
                        </h6>

                        <div id="extract-alert" class="d-none"></div>

                        <div id="extract-jobs-list" class="extraction-jobs-container mb-5">
                            <div class="text-secondary small text-center py-3">{{ 'spirit.memory.extract_panel.no_jobs'|trans }}</div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-8 col-sm-8 d-flex flex-column right-column">
            {# 3D Scene Viewport (top) #}
            <div class="rounded memory-graph-wrapper flex-grow-1">
                <div id="memory-graph-container" style="width: 100%; height: 100%; position: relative;">
                    <div id="memory-loading" class="position-absolute top-50 start-50 translate-middle text-center">
                        <div class="spinner-border text-cyber" role="status">
                            <span class="visually-hidden">{{ 'ui.loading'|trans }}</span>
                        </div>
                        <p class="mt-2 text-secondary">{{ 'spirit.memory.loading_graph'|trans }}</p>
                    </div>
                    <canvas id="memory-graph-canvas" class="rounded"></canvas>

                    {# View Controls Overlay (top-right) #}
                    <div class="graph-overlay graph-overlay-top-right">
                        <div class="btn-group border-0">
                            <button id="btn-reset-view" class="btn btn-sm btn-outline-secondary border-0" title="{{ 'spirit.memory.reset_view'|trans }}">
                                <i class="mdi mdi-video-3d"></i>
                            </button>
                            <button id="btn-top-view" class="btn btn-sm btn-outline-secondary border-0" title="{{ 'spirit.memory.top_view'|trans }}">
                                <i class="mdi mdi-dots-hexagon"></i>
                            </button>
                        </div>
                    </div>

                    {# Filters Overlay Container (bottom-right) #}
                    <div class="graph-overlay graph-overlay-bottom-right">
                        {# Categories Filter #}
                        <div class="graph-filter-box">
                            <div class="filter-section">
                                <div id="categories-filter" class="collapse show small legend-section">
                                    <div class="filter-item d-flex align-items-center justify-content-between">
                                        <label class="form-check-label" for="filter-cat-conversation">
                                            <span class="badge category-badge conversation">●</span> conversation
                                        </label>
                                        <div class="form-check form-switch mb-0">
                                            <input class="form-check-input filter-category" type="checkbox" id="filter-cat-conversation" data-category="conversation" checked>
                                        </div>
                                    </div>
                                    <div class="filter-item d-flex align-items-center justify-content-between">
                                        <label class="form-check-label" for="filter-cat-knowledge">
                                            <span class="badge category-badge knowledge">●</span> knowledge
                                        </label>
                                        <div class="form-check form-switch mb-0">
                                            <input class="form-check-input filter-category" type="checkbox" id="filter-cat-knowledge" data-category="knowledge" checked>
                                        </div>
                                    </div>
                                    <div class="filter-item d-flex align-items-center justify-content-between">
                                        <label class="form-check-label" for="filter-cat-preference">
                                            <span class="badge category-badge preference">●</span> preference
                                        </label>
                                        <div class="form-check form-switch mb-0">
                                            <input class="form-check-input filter-category" type="checkbox" id="filter-cat-preference" data-category="preference" checked>
                                        </div>
                                    </div>
                                    <div class="filter-item d-flex align-items-center justify-content-between">
                                        <label class="form-check-label" for="filter-cat-thought">
                                            <span class="badge category-badge thought">●</span> thought
                                        </label>
                                        <div class="form-check form-switch mb-0">
                                            <input class="form-check-input filter-category" type="checkbox" id="filter-cat-thought" data-category="thought" checked>
                                        </div>
                                    </div>
                                    <div class="filter-item d-flex align-items-center justify-content-between">
                                        <label class="form-check-label" for="filter-cat-fact">
                                            <span class="badge category-badge fact">●</span> fact
                                        </label>
                                        <div class="form-check form-switch mb-0">
                                            <input class="form-check-input filter-category" type="checkbox" id="filter-cat-fact" data-category="fact" checked>
                                        </div>
                                    </div>
                                    <div class="filter-item d-flex align-items-center justify-content-between">
                                        <label class="form-check-label" for="filter-cat-internet">
                                            <span class="badge category-badge internet">●</span> internet
                                        </label>
                                        <div class="form-check form-switch mb-0">
                                            <input class="form-check-input filter-category" type="checkbox" id="filter-cat-internet" data-category="internet" checked>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-0 filter-section-header" data-bs-toggle="collapse" data-bs-target="#categories-filter" role="button">
                                    <i class="mdi mdi-circle-multiple text-cyber me-2 ms-1"></i>
                                    {{ 'spirit.memory.legend_categories'|trans }}
                                    <i class="mdi mdi-menu-up filter-toggle-icon ms-auto"></i>
                                </div>
                            </div>
                        </div>

                        {# Relationships Filter #}
                        <div class="graph-filter-box">
                            <div class="filter-section">
                                <div id="relationships-filter" class="collapse show small legend-section">
                                    <div class="filter-item d-flex align-items-center justify-content-between">
                                        <label class="form-check-label" for="filter-rel-part-of">
                                            <span class="rel-color part-of">―</span> {{ 'spirit.memory.relationship_types.part_of'|trans }}
                                        </label>
                                        <div class="form-check form-switch mb-0">
                                            <input class="form-check-input filter-relationship" type="checkbox" id="filter-rel-part-of" data-relationship="PART_OF" checked>
                                        </div>
                                    </div>
                                    <div class="filter-item d-flex align-items-center justify-content-between">
                                        <label class="form-check-label" for="filter-rel-relates-to">
                                            <span class="rel-color relates-to">―</span> {{ 'spirit.memory.relationship_types.relates_to'|trans }}
                                        </label>
                                        <div class="form-check form-switch mb-0">
                                            <input class="form-check-input filter-relationship" type="checkbox" id="filter-rel-relates-to" data-relationship="RELATES_TO" checked>
                                        </div>
                                    </div>
                                    <div class="filter-item d-flex align-items-center justify-content-between">
                                        <label class="form-check-label" for="filter-rel-contradicts">
                                            <span class="rel-color contradicts">―</span> {{ 'spirit.memory.relationship_types.contradicts'|trans }}
                                        </label>
                                        <div class="form-check form-switch mb-0">
                                            <input class="form-check-input filter-relationship" type="checkbox" id="filter-rel-contradicts" data-relationship="CONTRADICTS" checked>
                                        </div>
                                    </div>
                                    <div class="filter-item d-flex align-items-center justify-content-between">
                                        <label class="form-check-label" for="filter-rel-reinforces">
                                            <span class="rel-color reinforces">―</span> {{ 'spirit.memory.relationship_types.reinforces'|trans }}
                                        </label>
                                        <div class="form-check form-switch mb-0">
                                            <input class="form-check-input filter-relationship" type="checkbox" id="filter-rel-reinforces" data-relationship="REINFORCES" checked>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-0 filter-section-header" data-bs-toggle="collapse" data-bs-target="#relationships-filter" role="button">
                                    <i class="mdi mdi-link-variant text-cyber me-2 ms-1"></i>
                                    {{ 'spirit.memory.legend_relationships'|trans }}
                                    <i class="mdi mdi-menu-up filter-toggle-icon ms-auto"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    {# Node Detail Overlay (bottom) #}
                    <div class="graph-overlay graph-overlay-bottom-left details-panel-horizontal">
                        <div id="node-details" class="d-none">
                            {# Row 1: Header + Summary + Dates #}
                            <div class="d-flex align-items-center gap-3 mb-2">
                                <h6  id="detail-summary"class="mb-0 flex-shrink-0 small">
                                </h6>
                                <div class="d-flex align-items-center gap-1 flex-shrink-0 ms-auto small text-secondary">                                    
                                    <i class="mdi mdi-eye-outline"></i>
                                    <span id="detail-access"></span>
                                </div>
                            </div>
                            {# Row 2: Category + Importance + Tags #}
                            <div class="d-flex align-items-center gap-4">
                                <div class="d-flex gap-1 flex-column">
                                    <div class="d-flex align-items-center gap-1 justify-content-between">
                                        <span class="detail-label-inline">{{ 'spirit.memory.category'|trans }}:</span>
                                        <div id="detail-category" class="badge badge-sm"></div>
                                    </div>
                                    <div class="d-flex align-items-center gap-1 justify-content-between">
                                        <span class="detail-label-inline">{{ 'spirit.memory.importance'|trans }}:</span>
                                        <div class="progress importance-bar" style="width: 60px; height: 6px;">
                                            <div id="detail-importance-bar" class="progress-bar bg-cyber" role="progressbar"></div>
                                        </div>
                                        <small id="detail-importance-value" class="text-cyber"></small>
                                    </div>
                                    <div class="d-flex align-items-center gap-1 justify-content-between small text-muted">
                                        <i class="mdi mdi-calendar-outline"></i>
                                        <span id="detail-created"></span>
                                    </div>
                                </div>
                                <div class="flex-grow-1 detail-tags-wrap">
                                    <div id="detail-tags" class="d-flex flex-wrap gap-1"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="node-placeholder" class="text-center text-secondary py-1 pt-3">
                            <i class="mdi mdi-cursor-default-click-outline me-2"></i>
                            {{ 'spirit.memory.click_node'|trans }}
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
    
</div>

{# Create Library Modal #}
<div class="modal fade" id="createLibraryModal" tabindex="-1" aria-labelledby="createLibraryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark">
            <div class="modal-header border-secondary">
                <h5 class="modal-title" id="createLibraryModalLabel">
                    <i class="mdi mdi-bookshelf text-cyber me-2"></i>
                    {{ 'spirit.memory.library_selector.create_title'|trans|default('Create Memory Library') }}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="library-name" class="form-label">{{ 'spirit.memory.library_selector.library_name'|trans|default('Library Name') }}</label>
                    <input type="text" class="form-control bg-dark text-light border-secondary" id="library-name" placeholder="e.g., Research Notes">
                </div>
                <div class="mb-3">
                    <label for="library-description" class="form-label">{{ 'spirit.memory.library_selector.library_description'|trans|default('Description') }} <small class="text-secondary">({{ 'ui.optional'|trans|default('optional') }})</small></label>
                    <textarea class="form-control bg-dark text-light border-secondary" id="library-description" rows="2" placeholder="What kind of memory packs will this library group?"></textarea>
                </div>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ 'ui.cancel'|trans }}</button>
                <button type="button" class="btn btn-cyber" id="btn-confirm-create-library">
                    <i class="mdi mdi-plus me-1"></i>{{ 'spirit.memory.library_selector.create_button'|trans|default('Create Library') }}
                </button>
            </div>
        </div>
    </div>
</div>

{# Create Pack Modal #}
<div class="modal fade" id="createPackModal" tabindex="-1" aria-labelledby="createPackModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark">
            <div class="modal-header border-secondary">
                <h5 class="modal-title" id="createPackModalLabel">
                    <i class="mdi mdi-package-variant-plus text-cyber me-2"></i>
                    {{ 'spirit.memory.pack_selector.create_title'|trans|default('Create Memory Pack') }}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="pack-name" class="form-label">{{ 'spirit.memory.pack_selector.pack_name'|trans|default('Pack Name') }}</label>
                    <input type="text" class="form-control bg-dark text-light border-secondary" id="pack-name" placeholder="e.g., Philosophy Notes">
                </div>
                <div class="mb-3">
                    <label for="pack-description" class="form-label">{{ 'spirit.memory.pack_selector.pack_description'|trans|default('Description') }} <small class="text-secondary">({{ 'ui.optional'|trans|default('optional') }})</small></label>
                    <textarea class="form-control bg-dark text-light border-secondary" id="pack-description" rows="2" placeholder="What kind of memories will this pack contain?"></textarea>
                </div>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ 'ui.cancel'|trans }}</button>
                <button type="button" class="btn btn-cyber" id="btn-confirm-create-pack">
                    <i class="mdi mdi-plus me-1"></i>{{ 'spirit.memory.pack_selector.create_button'|trans|default('Create Pack') }}
                </button>
            </div>
        </div>
    </div>
</div>

{# Library Details Modal #}
<div class="modal fade" id="libraryDetailsModal" tabindex="-1" aria-labelledby="libraryDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content glass-panel">
            <div class="modal-header">
                <h5 class="modal-title" id="libraryDetailsModalLabel">
                    <i class="mdi mdi-bookshelf text-cyber me-2"></i>{{ 'spirit.memory.library_selector.details_title'|trans|default('Library Details') }}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="libraryDetailsContent">
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal"><i class="mdi mdi-close me-1"></i>{{ 'ui.close'|trans }}</button>
            </div>
        </div>
    </div>
</div>

{# Delete Library Confirmation Modal #}
<div class="modal fade" id="deleteLibraryModal" tabindex="-1" aria-labelledby="deleteLibraryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content glass-panel">
            <div class="modal-header bg-danger">
                <span class="modal-title text-white" id="deleteLibraryModalLabel">
                    <i class="mdi mdi-delete-outline me-2"></i>{{ 'spirit.memory.library_selector.delete_title'|trans|default('Delete Library') }}
                </span>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3">
                    <i class="mdi mdi-alert-triangle text-warning fs-1"></i>
                </div>
                <p class="text-center">{{ 'spirit.memory.library_selector.delete_confirm'|trans|default('Are you sure you want to delete this library?') }}</p>
                <p class="text-muted small text-center">{{ 'spirit.memory.library_selector.delete_info'|trans|default('This will only remove the library file (.cqmlib). Memory packs referenced by this library will NOT be deleted.') }}</p>
            </div>
            <div class="modal-footer justify-content-between">
                <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">
                    <i class="mdi mdi-cancel me-1"></i>{{ 'ui.cancel'|trans }}
                </button>
                <button type="button" class="btn btn-sm btn-danger" id="btn-confirm-delete-library">
                    <i class="mdi mdi-delete me-1"></i>{{ 'ui.delete'|trans }}
                </button>
            </div>
        </div>
    </div>
</div>

{# Pack Details Modal #}
<div class="modal fade" id="packDetailsModal" tabindex="-1" aria-labelledby="packDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content glass-panel">
            <div class="modal-header">
                <h5 class="modal-title" id="packDetailsModalLabel">
                    <i class="mdi mdi-package-variant text-cyber me-2"></i>{{ 'spirit.memory.pack_selector.details_title'|trans|default('Pack Details') }}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="packDetailsContent">
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal"><i class="mdi mdi-close me-1"></i>{{ 'ui.close'|trans }}</button>
            </div>
        </div>
    </div>
</div>

{# Add Pack to Library Modal #}
<div class="modal fade" id="addPackToLibModal" tabindex="-1" aria-labelledby="addPackToLibModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content glass-panel">
            <div class="modal-header bg-cyber">
                <span class="modal-title text-dark" id="addPackToLibModalLabel">
                    <i class="mdi mdi-book-plus-outline me-2"></i>{{ 'spirit.memory.pack_selector.add_to_lib_title'|trans|default('Add Pack to Library') }}
                </span>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted small">{{ 'spirit.memory.pack_selector.add_to_lib_info'|trans|default('Select a library to add this pack to:') }}</p>
                <select id="add-pack-lib-select" class="form-select form-select-sm bg-dark text-light border-secondary">
                    <option value="">-- {{ 'spirit.memory.pack_selector.add_to_lib_select'|trans|default('Select a library') }} --</option>
                </select>
            </div>
            <div class="modal-footer justify-content-between">
                <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">
                    <i class="mdi mdi-cancel me-1"></i>{{ 'ui.cancel'|trans }}
                </button>
                <button type="button" class="btn btn-sm btn-cyber" id="btn-confirm-add-pack-to-lib">
                    <i class="mdi mdi-book-plus-outline me-1"></i>{{ 'spirit.memory.pack_selector.add_to_lib_button'|trans|default('Add to Library') }}
                </button>
            </div>
        </div>
    </div>
</div>

{# Remove Pack from Library Confirmation Modal #}
<div class="modal fade" id="removePackFromLibModal" tabindex="-1" aria-labelledby="removePackFromLibModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content glass-panel">
            <div class="modal-header bg-warning">
                <span class="modal-title text-dark" id="removePackFromLibModalLabel">
                    <i class="mdi mdi-book-remove-outline me-2"></i>{{ 'spirit.memory.pack_selector.remove_from_lib_title'|trans|default('Remove Pack from Library') }}
                </span>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3">
                    <i class="mdi mdi-book-remove text-warning fs-1"></i>
                </div>
                <p class="text-center">{{ 'spirit.memory.pack_selector.remove_from_lib_confirm'|trans|default('Remove this pack from the current library?') }}</p>
                <p class="text-muted small text-center">{{ 'spirit.memory.pack_selector.remove_from_lib_info'|trans|default('The pack file will NOT be deleted — it will only be unlinked from this library.') }}</p>
            </div>
            <div class="modal-footer justify-content-between">
                <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">
                    <i class="mdi mdi-cancel me-1"></i>{{ 'ui.cancel'|trans }}
                </button>
                <button type="button" class="btn btn-sm btn-warning" id="btn-confirm-remove-pack-from-lib">
                    <i class="mdi mdi-book-remove-outline me-1"></i>{{ 'spirit.memory.pack_selector.remove_from_lib_button'|trans|default('Remove from Library') }}
                </button>
            </div>
        </div>
    </div>
</div>

{# Delete Pack Confirmation Modal #}
<div class="modal fade" id="deletePackModal" tabindex="-1" aria-labelledby="deletePackModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content glass-panel">
            <div class="modal-header bg-danger">
                <span class="modal-title text-white" id="deletePackModalLabel">
                    <i class="mdi mdi-delete-outline me-2"></i>{{ 'spirit.memory.pack_selector.delete_title'|trans|default('Delete Memory Pack') }}
                </span>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3">
                    <i class="mdi mdi-alert-triangle text-warning fs-1"></i>
                </div>
                <p class="text-center">{{ 'spirit.memory.pack_selector.delete_confirm'|trans|default('Are you sure you want to delete this memory pack?') }}</p>
                <p class="text-danger small text-center fw-bold">{{ 'spirit.memory.pack_selector.delete_warning'|trans|default('This action is irreversible! All memory nodes and relationships in this pack will be permanently lost.') }}</p>
            </div>
            <div class="modal-footer justify-content-between">
                <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">
                    <i class="mdi mdi-cancel me-1"></i>{{ 'ui.cancel'|trans }}
                </button>
                <button type="button" class="btn btn-sm btn-danger" id="btn-confirm-delete-pack">
                    <i class="mdi mdi-delete me-1"></i>{{ 'ui.delete'|trans }}
                </button>
            </div>
        </div>
    </div>
</div>

{# Delete Node Confirmation Modal #}
<div class="modal fade" id="deleteNodeModal" tabindex="-1" aria-labelledby="deleteNodeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content glass-panel">
            <div class="modal-header bg-danger">
                <span class="modal-title text-white" id="deleteNodeModalLabel">
                    <i class="mdi mdi-delete-outline me-2"></i>{{ 'spirit.memory.delete_node.title'|trans|default('Delete Memory Node') }}
                </span>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3">
                    <i class="mdi mdi-alert-triangle text-warning fs-1"></i>
                </div>
                <p class="text-center">{{ 'spirit.memory.delete_node.confirm'|trans|default('Delete this memory node?') }}</p>
                <div id="deleteNodeInfo" class="text-center mb-2">
                    <span id="deleteNodeSummary" class="fw-bold text-cyber"></span>
                </div>
                <p id="deleteNodeChildrenWarning" class="text-warning small text-center d-none">
                    <i class="mdi mdi-alert me-1"></i>{{ 'spirit.memory.delete_node.children_warning'|trans|default('This node has children — all descendant nodes connected via PART_OF relationships will also be deleted.') }}
                </p>
                <p class="text-muted small text-center">{{ 'spirit.memory.delete_node.irreversible'|trans|default('This action cannot be undone.') }}</p>
            </div>
            <div class="modal-footer justify-content-between">
                <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">
                    <i class="mdi mdi-cancel me-1"></i>{{ 'ui.cancel'|trans }}
                </button>
                <button type="button" class="btn btn-sm btn-danger" id="btn-confirm-delete-node">
                    <i class="mdi mdi-delete me-1"></i>{{ 'ui.delete'|trans }}
                </button>
            </div>
        </div>
    </div>
</div>

{# Source Viewer Modal #}
<div class="modal fade" id="sourceViewerModal" tabindex="-1" aria-labelledby="sourceViewerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content bg-dark">
            <div class="modal-header border-secondary">
                <h5 class="modal-title" id="sourceViewerModalLabel">
                    <i class="mdi mdi-file-document-outline text-cyber me-2"></i>
                    {{ 'spirit.memory.source_viewer'|trans }}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div id="source-viewer-info" class="small text-secondary">
                        <span id="source-viewer-file"></span>
                        <span id="source-viewer-range" class="ms-2"></span>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-cyber" id="copySourceContentBtn">
                        <i class="mdi mdi-content-copy me-1"></i>{{ 'ui.copy'|trans }}
                    </button>
                </div>
                <pre id="source-viewer-content" class="bg-secondary bg-opacity-25 p-3 rounded" style="max-height: 60vh; overflow-y: auto; white-space: pre-wrap; word-wrap: break-word;"></pre>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><i class="mdi mdi-close me-2"></i>{{ 'ui.close'|trans }}</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        window.memoryExplorerTranslations = {
            relationship_types: {
                'PART_OF': '{{ 'spirit.memory.relationship_types.part_of'|trans }}',
                'RELATES_TO': '{{ 'spirit.memory.relationship_types.relates_to'|trans }}',
                'CONTRADICTS': '{{ 'spirit.memory.relationship_types.contradicts'|trans }}',
                'REINFORCES': '{{ 'spirit.memory.relationship_types.reinforces'|trans }}'
            },
            extract_panel: {
                show: '{{ 'spirit.memory.extract_panel.show'|trans }}',
                hide: '{{ 'spirit.memory.extract_panel.hide'|trans }}',
                no_jobs: '{{ 'spirit.memory.extract_panel.no_jobs'|trans }}',
                steps: '{{ 'spirit.memory.extract_panel.steps'|trans }}',
                job_types: {
                    extract_recursive: '{{ 'spirit.memory.extract_panel.job_types.extract_recursive'|trans }}',
                    analyze_relationships: '{{ 'spirit.memory.extract_panel.job_types.analyze_relationships'|trans }}'
                },
                extraction_started: '{{ 'spirit.memory.extract_panel.extraction_started'|trans }}',
                extraction_completed: '{{ 'spirit.memory.extract_panel.extraction_completed'|trans }}',
                extraction_failed: '{{ 'spirit.memory.extract_panel.extraction_failed'|trans }}',
                select_file_first: '{{ 'spirit.memory.extract_panel.select_file_first'|trans }}',
                select_spirit: '{{ 'spirit.memory.extract_panel.select_spirit'|trans }}',
                select_conversation: '{{ 'spirit.memory.extract_panel.select_conversation'|trans }}',
                no_spirits: '{{ 'spirit.memory.extract_panel.no_spirits'|trans }}',
                no_conversations: '{{ 'spirit.memory.extract_panel.no_conversations'|trans }}',
                select_conversation_first: '{{ 'spirit.memory.extract_panel.select_conversation_first'|trans }}',
                start_analysis: '{{ 'spirit.memory.extract_panel.start_analysis'|trans }}',
                abort_job: '{{ 'spirit.memory.extract_panel.abort_job'|trans|default('Abort job') }}'
            },
            library_selector: {
                all_packs: '{{ 'spirit.memory.library_selector.all_packs'|trans|default('All Packs') }}',
                create_success: '{{ 'spirit.memory.library_selector.create_success'|trans|default('Library created successfully') }}',
                create_error: '{{ 'spirit.memory.library_selector.create_error'|trans|default('Failed to create library') }}',
                name_required: '{{ 'spirit.memory.library_selector.name_required'|trans|default('Library name is required') }}'
            },
            pack_selector: {
                select_pack: '{{ 'spirit.memory.pack_selector.select_pack'|trans|default('Select a pack') }}',
                no_packs: '{{ 'spirit.memory.pack_selector.no_packs'|trans|default('No packs found') }}',
                loading: '{{ 'spirit.memory.pack_selector.loading'|trans|default('Loading packs...') }}',
                create_success: '{{ 'spirit.memory.pack_selector.create_success'|trans|default('Pack created successfully') }}',
                create_error: '{{ 'spirit.memory.pack_selector.create_error'|trans|default('Failed to create pack') }}',
                add_to_lib_success: '{{ 'spirit.memory.pack_selector.add_to_lib_success'|trans|default('Pack added to library') }}',
                add_to_lib_error: '{{ 'spirit.memory.pack_selector.add_to_lib_error'|trans|default('Failed to add pack to library') }}',
                nodes: '{{ 'spirit.memory.nodes'|trans }}',
                legacy_mode: '{{ 'spirit.memory.pack_selector.legacy_mode'|trans|default('Legacy (user database)') }}'
            }
        };
    </script>
    {{ encore_entry_script_tags('cq-memory') }}
{% endblock %}
