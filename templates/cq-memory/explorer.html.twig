{% extends 'base.html.twig' %}

{% block title %}{{ 'spirit.memory.title'|trans }}{% if spirit %} - {{ spirit.name }}{% endif %}{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    {{ encore_entry_link_tags('cq-memory') }}
{% endblock %}

{% block body %}
<div class="container-fluid memory-explorer">
    {% if spiritId %}
    <input type="hidden" id="spirit-id" value="{{ spiritId }}">
    <input type="hidden" id="spirit-name" value="{{ spirit.name }}">
    {% endif %}
    
    <div class="row">
        <div class="col-12">
            <div class="glass-panel mb-3">
                <div class="d-flex justify-content-between align-items-center p-3">
                    <div class="d-flex align-items-center">
                        {% if spirit %}
                        <a href="{{ path('spirit_show', {id: spiritId}) }}" class="btn btn-sm btn-outline-secondary me-3">
                            <i class="mdi mdi-arrow-left"></i>
                        </a>
                        {% else %}
                        <a href="{{ path('app_dashboard') }}" class="btn btn-sm btn-outline-secondary me-3">
                            <i class="mdi mdi-arrow-left"></i>
                        </a>
                        {% endif %}
                        <h4 class="mb-0">
                            <i class="mdi mdi-brain text-cyber me-2"></i>
                            {{ 'spirit.memory.title'|trans }}{% if spirit %} - {{ spirit.name }}{% endif %}
                        </h4>
                    </div>
                    <div class="d-flex align-items-center gap-2">
                        {# Pack Selector #}
                        <div class="d-flex align-items-center me-3">
                            <label class="form-label small text-secondary mb-0 me-2 d-none d-md-inline">
                                <i class="mdi mdi-package-variant"></i>
                            </label>
                            <select id="pack-selector" class="form-select form-select-sm bg-dark text-light border-secondary" style="min-width: 180px;">
                                <option value="">-- {{ 'spirit.memory.pack_selector.loading'|trans|default('Loading packs...') }} --</option>
                            </select>
                            <button id="btn-create-pack" class="btn btn-sm btn-outline-cyber ms-1" title="{{ 'spirit.memory.pack_selector.create_new'|trans|default('Create new pack') }}">
                                <i class="mdi mdi-plus"></i>
                            </button>
                        </div>
                        
                        <div id="memory-stats" class="d-flex gap-3 me-3">
                            <span class="badge bg-secondary">
                                <i class="mdi mdi-circle-multiple"></i>
                                <span id="stats-nodes">0</span> {{ 'spirit.memory.nodes'|trans }}
                            </span>
                            <span class="badge bg-secondary">
                                <i class="mdi mdi-link-variant"></i>
                                <span id="stats-edges">0</span> {{ 'spirit.memory.relationships'|trans }}
                            </span>
                        </div>
                        <div class="btn-group">
                            <button id="btn-reset-view" class="btn btn-sm btn-outline-secondary" title="{{ 'spirit.memory.reset_view'|trans }}">
                                <i class="mdi mdi-video-3d"></i>
                            </button>
                            <button id="btn-top-view" class="btn btn-sm btn-outline-secondary" title="{{ 'spirit.memory.top_view'|trans }}">
                                <i class="mdi mdi-arrow-collapse-down"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-4 col-md-4">
            <div class="glass-panel p-3 memory-panel compilation-panel">
                <h5 class="mb-3">
                    <i class="mdi mdi-file-document-multiple text-cyber me-2"></i>
                    {{ 'spirit.memory.compilation'|trans }}
                </h5>
                
                <div id="compilation-placeholder" class="text-center text-secondary py-5 placeholder-state">
                    <i class="mdi mdi-selection-ellipse placeholder-icon"></i>
                    <p class="mt-2">{{ 'spirit.memory.select_for_compilation'|trans }}</p>
                </div>
                
                <div id="compilation-content" class="d-none">
                    <div id="compilation-selected" class="mb-3">
                        <label class="form-label small text-cyber d-flex align-items-center">
                            <i class="mdi mdi-star me-1"></i>
                            {{ 'spirit.memory.selected_memory'|trans }}
                        </label>
                        <div id="compilation-selected-content" class="small p-2 rounded compilation-selected"></div>
                    </div>
                    
                    <div id="compilation-related">
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-6 col-md-4">
            <div class="rounded memory-graph-wrapper">
                <div id="memory-graph-container" style="width: 100%; height: 100%; position: relative;">
                    <div id="memory-loading" class="position-absolute top-50 start-50 translate-middle text-center">
                        <div class="spinner-border text-cyber" role="status">
                            <span class="visually-hidden">{{ 'ui.loading'|trans }}</span>
                        </div>
                        <p class="mt-2 text-secondary">{{ 'spirit.memory.loading_graph'|trans }}</p>
                    </div>
                    <canvas id="memory-graph-canvas" class="rounded"></canvas>
                </div>
            </div>
        </div>
        
        <div class="col-lg-2 col-md-4">
            <div class="glass-panel p-3 memory-panel details-panel">
                <h5 class="mb-3">
                    <i class="mdi mdi-information-outline text-cyber me-2"></i>
                    {{ 'spirit.memory.details'|trans }}
                </h5>
                
                <div id="node-details" class="d-none">
                    <div class="detail-section">
                        <label class="detail-label">{{ 'spirit.memory.importance'|trans }}</label>
                        <div class="progress importance-bar">
                            <div id="detail-importance-bar" class="progress-bar bg-cyber" role="progressbar"></div>
                        </div>
                        <small id="detail-importance-value" class="text-cyber"></small>
                    </div>
                    
                    <div class="detail-section">
                        <label class="detail-label">{{ 'spirit.memory.summary'|trans }}</label>
                        <p id="detail-summary" class="mb-0 small"></p>
                    </div>
                    
                    <div class="detail-section">
                        <label class="detail-label">{{ 'spirit.memory.category'|trans }}</label>
                        <div id="detail-category" class="badge"></div>
                    </div>
                    
                    <div class="detail-section">
                        <label class="detail-label">{{ 'spirit.memory.tags'|trans }}</label>
                        <div id="detail-tags"></div>
                    </div>
                    
                    <div class="detail-section">
                        <label class="detail-label">{{ 'spirit.memory.created_at'|trans }}</label>
                        <p id="detail-created" class="mb-0 small text-secondary"></p>
                    </div>
                    
                    <div class="detail-section">
                        <label class="detail-label">{{ 'spirit.memory.access_count'|trans }}</label>
                        <p id="detail-access" class="mb-0 small text-secondary"></p>
                    </div>
                </div>
                
                <div id="node-placeholder" class="text-center text-secondary placeholder-state">
                    <i class="mdi mdi-cursor-default-click-outline placeholder-icon"></i>
                    <p class="mt-2">{{ 'spirit.memory.click_node'|trans }}</p>
                </div>
                
                <hr class="my-3">
                
                {# Categories Filter #}
                <div class="filter-section mb-3">
                    <h6 class="mb-2 filter-section-header" data-bs-toggle="collapse" data-bs-target="#categories-filter" role="button">
                        <i class="mdi mdi-circle-multiple text-cyber me-2"></i>
                        {{ 'spirit.memory.legend_categories'|trans }}
                        <i class="mdi mdi-chevron-down filter-toggle-icon ms-auto"></i>
                    </h6>
                    <div id="categories-filter" class="collapse show small legend-section">
                        <div class="filter-item d-flex align-items-center justify-content-between">
                            <label class="form-check-label" for="filter-cat-conversation">
                                <span class="badge category-badge conversation">●</span> conversation
                            </label>
                            <div class="form-check form-switch mb-0">
                                <input class="form-check-input filter-category" type="checkbox" id="filter-cat-conversation" data-category="conversation" checked>
                            </div>
                        </div>
                        <div class="filter-item d-flex align-items-center justify-content-between">
                            <label class="form-check-label" for="filter-cat-knowledge">
                                <span class="badge category-badge knowledge">●</span> knowledge
                            </label>
                            <div class="form-check form-switch mb-0">
                                <input class="form-check-input filter-category" type="checkbox" id="filter-cat-knowledge" data-category="knowledge" checked>
                            </div>
                        </div>
                        <div class="filter-item d-flex align-items-center justify-content-between">
                            <label class="form-check-label" for="filter-cat-preference">
                                <span class="badge category-badge preference">●</span> preference
                            </label>
                            <div class="form-check form-switch mb-0">
                                <input class="form-check-input filter-category" type="checkbox" id="filter-cat-preference" data-category="preference" checked>
                            </div>
                        </div>
                        <div class="filter-item d-flex align-items-center justify-content-between">
                            <label class="form-check-label" for="filter-cat-thought">
                                <span class="badge category-badge thought">●</span> thought
                            </label>
                            <div class="form-check form-switch mb-0">
                                <input class="form-check-input filter-category" type="checkbox" id="filter-cat-thought" data-category="thought" checked>
                            </div>
                        </div>
                        <div class="filter-item d-flex align-items-center justify-content-between">
                            <label class="form-check-label" for="filter-cat-fact">
                                <span class="badge category-badge fact">●</span> fact
                            </label>
                            <div class="form-check form-switch mb-0">
                                <input class="form-check-input filter-category" type="checkbox" id="filter-cat-fact" data-category="fact" checked>
                            </div>
                        </div>
                    </div>
                </div>
                
                {# Relationships Filter #}
                <div class="filter-section">
                    <h6 class="mb-2 filter-section-header" data-bs-toggle="collapse" data-bs-target="#relationships-filter" role="button">
                        <i class="mdi mdi-link-variant text-cyber me-2"></i>
                        {{ 'spirit.memory.legend_relationships'|trans }}
                        <i class="mdi mdi-chevron-down filter-toggle-icon ms-auto"></i>
                    </h6>
                    <div id="relationships-filter" class="collapse show small legend-section">
                        <div class="filter-item d-flex align-items-center justify-content-between">
                            <label class="form-check-label" for="filter-rel-relates-to">
                                <span class="rel-color relates-to">―</span> {{ 'spirit.memory.relationship_types.relates_to'|trans }}
                            </label>
                            <div class="form-check form-switch mb-0">
                                <input class="form-check-input filter-relationship" type="checkbox" id="filter-rel-relates-to" data-relationship="RELATES_TO" checked>
                            </div>
                        </div>
                        <div class="filter-item d-flex align-items-center justify-content-between">
                            <label class="form-check-label" for="filter-rel-derived-from">
                                <span class="rel-color derived-from">―</span> {{ 'spirit.memory.relationship_types.derived_from'|trans }}
                            </label>
                            <div class="form-check form-switch mb-0">
                                <input class="form-check-input filter-relationship" type="checkbox" id="filter-rel-derived-from" data-relationship="DERIVED_FROM" checked>
                            </div>
                        </div>
                        <div class="filter-item d-flex align-items-center justify-content-between">
                            <label class="form-check-label" for="filter-rel-evolved-into">
                                <span class="rel-color evolved-into">―</span> {{ 'spirit.memory.relationship_types.evolved_into'|trans }}
                            </label>
                            <div class="form-check form-switch mb-0">
                                <input class="form-check-input filter-relationship" type="checkbox" id="filter-rel-evolved-into" data-relationship="EVOLVED_INTO" checked>
                            </div>
                        </div>
                        <div class="filter-item d-flex align-items-center justify-content-between">
                            <label class="form-check-label" for="filter-rel-part-of">
                                <span class="rel-color part-of">―</span> {{ 'spirit.memory.relationship_types.part_of'|trans }}
                            </label>
                            <div class="form-check form-switch mb-0">
                                <input class="form-check-input filter-relationship" type="checkbox" id="filter-rel-part-of" data-relationship="PART_OF" checked>
                            </div>
                        </div>
                        <div class="filter-item d-flex align-items-center justify-content-between">
                            <label class="form-check-label" for="filter-rel-contradicts">
                                <span class="rel-color contradicts">―</span> {{ 'spirit.memory.relationship_types.contradicts'|trans }}
                            </label>
                            <div class="form-check form-switch mb-0">
                                <input class="form-check-input filter-relationship" type="checkbox" id="filter-rel-contradicts" data-relationship="CONTRADICTS" checked>
                            </div>
                        </div>
                        <div class="filter-item d-flex align-items-center justify-content-between">
                            <label class="form-check-label" for="filter-rel-reinforces">
                                <span class="rel-color reinforces">―</span> {{ 'spirit.memory.relationship_types.reinforces'|trans }}
                            </label>
                            <div class="form-check form-switch mb-0">
                                <input class="form-check-input filter-relationship" type="checkbox" id="filter-rel-reinforces" data-relationship="REINFORCES" checked>
                            </div>
                        </div>
                        <div class="filter-item d-flex align-items-center justify-content-between">
                            <label class="form-check-label" for="filter-rel-supersedes">
                                <span class="rel-color supersedes">―</span> {{ 'spirit.memory.relationship_types.supersedes'|trans }}
                            </label>
                            <div class="form-check form-switch mb-0">
                                <input class="form-check-input filter-relationship" type="checkbox" id="filter-rel-supersedes" data-relationship="SUPERSEDES" checked>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    {# Memory Extract Panel - Full Width Collapsible #}
    <div class="row mt-3">
        <div class="col-12">
            <button id="btn-toggle-extract-panel" class="btn btn-sm btn-outline-cyber mb-2">
                <i class="mdi mdi-chevron-down"></i> {{ 'spirit.memory.extract_panel.show'|trans }}
            </button>
            
            <div id="memory-extract-panel" class="glass-panel p-3 d-none">
                <h5 class="mb-3">
                    <i class="mdi mdi-brain text-cyber me-2"></i>
                    {{ 'spirit.memory.extract_panel.title'|trans }}
                </h5>
                
                <div id="extract-alert" class="d-none"></div>
                
                <div class="row">
                    {# Left Column - Extraction Form #}
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="form-label small text-cyber">
                                <i class="mdi mdi-file-document me-1"></i>
                                {{ 'spirit.memory.extract_panel.select_file'|trans }}
                            </label>
                            <select id="extract-file-selector" class="form-select form-select-sm bg-dark text-light border-secondary">
                                <option value="">-- Select a file --</option>
                                {# TODO: Populate from File Browser / Project Files #}
                            </select>
                            <div class="small text-secondary mt-1">
                                Selected: <span id="extract-selected-file" class="text-cyber">None</span>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label small text-cyber d-flex justify-content-between">
                                <span>
                                    <i class="mdi mdi-layers-triple me-1"></i>
                                    {{ 'spirit.memory.extract_panel.max_depth'|trans }}
                                </span>
                                <span id="extract-max-depth-value" class="badge bg-cyber">3</span>
                            </label>
                            <input type="range" class="form-range" id="extract-max-depth" min="1" max="5" value="3">
                            <div class="d-flex justify-content-between small text-secondary">
                                <span>1 ({{ 'spirit.memory.extract_panel.depth_fast'|trans }})</span>
                                <span>5 ({{ 'spirit.memory.extract_panel.depth_deep'|trans }})</span>
                            </div>
                        </div>
                        
                        <button id="btn-start-extraction" class="btn btn-sm btn-cyber w-100" disabled>
                            <i class="mdi mdi-brain"></i> {{ 'spirit.memory.extract_panel.start_extraction'|trans }}
                        </button>
                    </div>
                    
                    {# Middle Column - Active Jobs #}
                    <div class="col-md-6">
                        <h6 class="small text-cyber mb-2">
                            <i class="mdi mdi-progress-clock me-1"></i>
                            {{ 'spirit.memory.extract_panel.active_jobs'|trans }}
                        </h6>
                        <div id="extract-jobs-list" class="extraction-jobs-container">
                            <div class="text-secondary small text-center py-3">{{ 'spirit.memory.extract_panel.no_jobs'|trans }}</div>
                        </div>
                    </div>
                    
                    {# Right Column - Info/Instructions #}
                    <div class="col-md-3">
                        <div class="small text-secondary">
                            <h6 class="small text-cyber mb-2">
                                <i class="mdi mdi-information-outline me-1"></i>
                                {{ 'spirit.memory.extract_panel.how_it_works'|trans }}
                            </h6>
                            <ul class="mb-0" style="font-size: 0.85rem;">
                                <li>{{ 'spirit.memory.extract_panel.instruction_1'|trans }}</li>
                                <li>{{ 'spirit.memory.extract_panel.instruction_2'|trans }}</li>
                                <li>{{ 'spirit.memory.extract_panel.instruction_3'|trans }}</li>
                                <li>{{ 'spirit.memory.extract_panel.instruction_4'|trans }}</li>
                                <li>{{ 'spirit.memory.extract_panel.instruction_5'|trans }}</li>
                            </ul>
                            <div class="mt-3 p-2 bg-secondary bg-opacity-25 rounded">
                                <div class="small">
                                    <i class="mdi mdi-lightbulb-on-outline text-cyber me-1"></i>
                                    {{ 'spirit.memory.extract_panel.tip'|trans }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{# Create Pack Modal #}
<div class="modal fade" id="createPackModal" tabindex="-1" aria-labelledby="createPackModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark">
            <div class="modal-header border-secondary">
                <h5 class="modal-title" id="createPackModalLabel">
                    <i class="mdi mdi-package-variant-plus text-cyber me-2"></i>
                    {{ 'spirit.memory.pack_selector.create_title'|trans|default('Create Memory Pack') }}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="pack-name" class="form-label">{{ 'spirit.memory.pack_selector.pack_name'|trans|default('Pack Name') }}</label>
                    <input type="text" class="form-control bg-dark text-light border-secondary" id="pack-name" placeholder="e.g., Philosophy Notes">
                </div>
                <div class="mb-3">
                    <label for="pack-description" class="form-label">{{ 'spirit.memory.pack_selector.pack_description'|trans|default('Description') }} <small class="text-secondary">({{ 'ui.optional'|trans|default('optional') }})</small></label>
                    <textarea class="form-control bg-dark text-light border-secondary" id="pack-description" rows="2" placeholder="What kind of memories will this pack contain?"></textarea>
                </div>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ 'ui.cancel'|trans }}</button>
                <button type="button" class="btn btn-cyber" id="btn-confirm-create-pack">
                    <i class="mdi mdi-plus me-1"></i>{{ 'spirit.memory.pack_selector.create_button'|trans|default('Create Pack') }}
                </button>
            </div>
        </div>
    </div>
</div>

{# Source Viewer Modal #}
<div class="modal fade" id="sourceViewerModal" tabindex="-1" aria-labelledby="sourceViewerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content bg-dark">
            <div class="modal-header border-secondary">
                <h5 class="modal-title" id="sourceViewerModalLabel">
                    <i class="mdi mdi-file-document-outline text-cyber me-2"></i>
                    {{ 'spirit.memory.source_viewer'|trans }}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div id="source-viewer-info" class="small text-secondary">
                        <span id="source-viewer-file"></span>
                        <span id="source-viewer-range" class="ms-2"></span>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-cyber" id="copySourceContentBtn">
                        <i class="mdi mdi-content-copy me-1"></i>{{ 'ui.copy'|trans }}
                    </button>
                </div>
                <pre id="source-viewer-content" class="bg-secondary bg-opacity-25 p-3 rounded" style="max-height: 60vh; overflow-y: auto; white-space: pre-wrap; word-wrap: break-word;"></pre>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><i class="mdi mdi-close me-2"></i>{{ 'ui.close'|trans }}</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        window.memoryExplorerTranslations = {
            relationship_types: {
                'RELATES_TO': '{{ 'spirit.memory.relationship_types.relates_to'|trans }}',
                'DERIVED_FROM': '{{ 'spirit.memory.relationship_types.derived_from'|trans }}',
                'EVOLVED_INTO': '{{ 'spirit.memory.relationship_types.evolved_into'|trans }}',
                'PART_OF': '{{ 'spirit.memory.relationship_types.part_of'|trans }}',
                'CONTRADICTS': '{{ 'spirit.memory.relationship_types.contradicts'|trans }}',
                'REINFORCES': '{{ 'spirit.memory.relationship_types.reinforces'|trans }}',
                'SUPERSEDES': '{{ 'spirit.memory.relationship_types.supersedes'|trans }}'
            },
            extract_panel: {
                show: '{{ 'spirit.memory.extract_panel.show'|trans }}',
                hide: '{{ 'spirit.memory.extract_panel.hide'|trans }}',
                no_jobs: '{{ 'spirit.memory.extract_panel.no_jobs'|trans }}',
                steps: '{{ 'spirit.memory.extract_panel.steps'|trans }}',
                job_types: {
                    extract_recursive: '{{ 'spirit.memory.extract_panel.job_types.extract_recursive'|trans }}',
                    analyze_relationships: '{{ 'spirit.memory.extract_panel.job_types.analyze_relationships'|trans }}'
                },
                extraction_started: '{{ 'spirit.memory.extract_panel.extraction_started'|trans }}',
                extraction_completed: '{{ 'spirit.memory.extract_panel.extraction_completed'|trans }}',
                extraction_failed: '{{ 'spirit.memory.extract_panel.extraction_failed'|trans }}',
                select_file_first: '{{ 'spirit.memory.extract_panel.select_file_first'|trans }}'
            },
            pack_selector: {
                select_pack: '{{ 'spirit.memory.pack_selector.select_pack'|trans|default('Select a pack') }}',
                no_packs: '{{ 'spirit.memory.pack_selector.no_packs'|trans|default('No packs found') }}',
                loading: '{{ 'spirit.memory.pack_selector.loading'|trans|default('Loading packs...') }}',
                create_success: '{{ 'spirit.memory.pack_selector.create_success'|trans|default('Pack created successfully') }}',
                create_error: '{{ 'spirit.memory.pack_selector.create_error'|trans|default('Failed to create pack') }}',
                nodes: '{{ 'spirit.memory.nodes'|trans }}',
                legacy_mode: '{{ 'spirit.memory.pack_selector.legacy_mode'|trans|default('Legacy (user database)') }}'
            }
        };
    </script>
    {{ encore_entry_script_tags('cq-memory') }}
{% endblock %}
